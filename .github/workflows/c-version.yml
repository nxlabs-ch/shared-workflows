name: Check C version against TAG version

on:
  workflow_call:
    inputs:
      version:
        description: "The TAG version string for this release"
        required: true
        type: string
      header_file:
        description: "The path to the header file"
        required: false
        type: string
        default: "src/version.h"
      version_define:
        description: "The name of the #define in the header file that contains the version string"
        required: false
        type: string
        default: "VERSION"
    
jobs:
    c-version:
        runs-on: ubuntu-24.04
        steps:
        - uses: actions/checkout@v6

        - name: Strip v from TAG
          run: |
            TAG=${{ inputs.version }}
            echo "EXPECTED_VERSION=${TAG#v}" >> $GITHUB_ENV

        - name: Get C version from code
          id: c-version
          run: |
            echo "lib_version=$(head -n 10 $HEADER_FILE | grep define | grep $VERSION_DEFINE -m 1 | sed 's/"/ /g' | awk '{print $3}')" >> $GITHUB_OUTPUT
          env:
            HEADER_FILE: ${{ inputs.header_file }}
            VERSION_DEFINE: ${{ inputs.version_define }}
        
        - name: Display versions
          run: |
            echo "C library version: '${{ steps.c-version.outputs.lib_version }}'"
            echo "Expected version: '$EXPECTED_VERSION'"

        - name: Check C version
          run: |
            if [[ "${{ steps.c-version.outputs.lib_version }}" != "$EXPECTED_VERSION" ]]; then
                echo "C library version mismatch: ${{ steps.c-version.outputs.lib_version }} != $EXPECTED_VERSION"
                if [[ "$EXPECTED_VERSION" == "" ]]; then
                    echo "This is a pre-release version, so this is expected."
                    exit 0
                else
                    echo "This is a release version, so this is unexpected."
                    exit 1
                fi
            fi
