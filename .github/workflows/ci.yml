on:
  pull_request:
  push:

jobs:
  version:
    uses: ./.github/workflows/version.yml
    with:
      preface: "release/preface.md"
      postface: "release/postface.md"
    secrets:
      FF_MERGE_PAT: ${{ secrets.FF_MERGE_PAT }}

  check-rust-version:
    needs: version
    uses: ./.github/workflows/rust-version.yml
    with: 
      version: ${{ needs.version.outputs.tag }}
      cargo_toml_dir: samples/rust
  
  check-toml-version:
    needs: version
    uses: ./.github/workflows/toml-version.yml
    with: 
      version: ${{ needs.version.outputs.tag }}
      toml_file: docs/pyproject.toml

  check-spec-version:
      needs: version
      uses: ./.github/workflows/spec-version.yml
      with: 
        version: ${{ needs.version.outputs.tag }}
        spec_file: samples/spec/test.spec

  check-spec-version-2:
      needs: version
      uses: ./.github/workflows/spec-version.yml
      with: 
        version: ${{ needs.version.outputs.tag }}
        spec_file: samples/spec/test2.spec

  check-kicad-version:
    needs: version
    uses: ./.github/workflows/kicad-version.yml
    with: 
      version: ${{ needs.version.outputs.tag }}
      kicad_sch_path: samples/kicad/sample/sample.kicad_sch

  kicad-release-v9:
    needs: [version, check-kicad-version]
    uses: ./.github/workflows/kicad-release.yml
    with: 
      version: ${{ needs.version.outputs.version }}
      dir: samples/kicad
      name: sample
      kibot-version: v9
    
  docs:
    if: ${{ github.event_name == 'pull_request' || github.ref == 'refs/heads/main' }}
    needs: [version, check-toml-version]
    uses: ./.github/workflows/docs.yml
    with:
      version: ${{ needs.version.outputs.version }}
      pdf-name: "shared-workflows.pdf"
      dependencies: "sphinx_pdj_theme==0.7.3"

  uv-docs:
    needs: [version, check-toml-version]
    uses: ./.github/workflows/uv-docs.yml
    with:
      version: ${{ needs.version.outputs.version }}
      pdf-name: "shared-workflows.pdf"
      build-pdf: ${{ github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      makefile: "uv-makefile"

  prepare-changes:
    needs: version
    runs-on: ubuntu-24.04
    outputs:
      changes: ${{ steps.aggregate.outputs.changes }}
    steps:
      - name: Aggregate changelog content
        id: aggregate
        run: |
          {
            echo 'changes<<EOF'
            cat << 'CONTENT_EOF'
          ${{ needs.version.outputs.preface_content }}
          ${{ needs.version.outputs.changelog }}
          ${{ needs.version.outputs.postface_content }}
          CONTENT_EOF
            echo EOF
          } >> "$GITHUB_OUTPUT"


  deploy:
    if: github.ref == 'refs/heads/main'
    needs: [version, uv-docs, prepare-changes]
    uses: ./.github/workflows/deploy-gs.yml
    with:
      version: ${{ needs.version.outputs.version }}
      project: shared-workflows
      changes: ${{ needs.prepare-changes.outputs.changes }}
    secrets:
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}

  release:
    if: github.ref == 'refs/heads/main'
    needs: [version, docs, uv-docs,kicad-release-v9]
    uses: ./.github/workflows/deploy-release.yml
    with:
      tag: ${{ needs.version.outputs.tag }}

  test-gcloud-upload:
    if: ${{ github.event_name == 'pull_request' || github.ref == 'refs/heads/main' }}
    needs: version
    uses: ./.github/workflows/gcloud-upload-artifact.yml
    with:
      version: ${{ needs.version.outputs.version }}
      source: "docs/gcloud.md"
      destination: shared-workflows
    secrets:
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}